#+title: My emacs configuration via org mode!
#+author: Me. Your friendly neighborhood web developer

* Learnings
Here is a list of stuff I set out to learn as I began using emacs
after using vim for three years

** Terminology / good to know
1) ~C-x C-c~ to quit emacs
2) ~C-h i m~ transient RET
3) ~M-x~ execute extended command
4) ~C-g~ to escape
5) ~C-h ?~ about help
6) ~C-h t~ opens the emacs tutorial
7) ~C-h k~ [key or chord] opens help about that key or string of keys
8) ~C-v~ scroll down one screen
9) ~M-v~ scroll up one screen
10) ~C-s~ start incremental search / go to next match
11) ~C-x 0~ kill current window

** Editor configuration
- ~M-x customize RET~

** Line navigation
1) marks equivalent
2) vim-sneak equivalent
3) vim-surround equivalent
4) wellle/targets.vim equivalent
5) How to toggle comments

** File navigation
- File finder?

** Package manager
- ~M-x package-install RET~

** Code editing
1) emmet?
2) Intellisense / LSP capabilities?
   - Depends. There's stuff like lsp-mode and you can also use something like tide for javascript

** Visuals
1) statusline?
2) doom-modeline
3) icons?
4) Syntax highlighting
   * Colorscheme
5) Hex/RGBA/HSL color previews
6) Whichkey equivalent?

** How to close
- ~C-x C-c~


* Config
** Keybinding utils

#+begin_src emacs-lisp

  (defun sal-switch-linum-mode ()
    (interactive)
    (if (eq 'relative display-line-numbers)
        (setq display-line-numbers 'absolute)
      (setq display-line-numbers 'relative)))

  (use-package general
    :after evil
    :config
    (general-create-definer leader-keys
      :states '(normal insert visual emacs)
      :keymaps 'override
      :prefix "SPC"
      :global-prefix "C-SPC")
      ;; Toggles
      (leader-keys
          "br" 'rename-buffer)
      (leader-keys
          "T"  '(:ignore t :which-key "toggles")
          "Tn" '(sal-switch-linum-mode :which-key "change linum mode")))

#+end_src
** Some basic level stuff

#+begin_src emacs-lisp

  ;; Suppress warnings about cl being deprecated
  (setq byte-compile-warnings '(cl-functions))

  ;; Don't create lockfiles
  (setq create-lockfiles nil)

  ;; Don't auto save
  (setq auto-save-default nil)

  ;; Backup files in ~/.saves
  (setq backup-directory-alist '(("." . "~/.config/emacs/.saves")))

  ;; Font
  (set-face-attribute 'default nil :font "Source Code Pro" :height 130)

  ;; Remember where you were last in a file
  (save-place-mode 1)

  ;; Match brackets and other stuff when typing. Another alternative: https://github.com/Fuco1/smartparens
  (electric-pair-mode 1)

  (tool-bar-mode -1)   ;; Hide toolbar
  (menu-bar-mode -1)   ;; Hide menubar
  (scroll-bar-mode -1) ;; Hide scrollbar

  ;; Show column number in addition to line number
  (column-number-mode)

  ;; When on a bracket, highlight its matching one
  (show-paren-mode 1)

  ;; Replace yes-no questions with y-n questions
  (defalias 'yes-or-no-p #'y-or-n-p)

  ;; Hide start message
  (setq inhibit-startup-message t)

  ;; Don't indent with tabs
  (setq-default indent-tabs-mode nil)

  ;; Tab key should generate 4 spaces
  (setq-default tab-width 4)

  (setq indent-line-function 'insert-tab)

  ;; Maximize screen size at start
  (custom-set-variables
      '(initial-frame-alist (quote ((fullscreen . maximized)))))

  ;; Enable having frames for UI
  (use-package posframe
    :defer 1)

  (global-linum-mode -1)
  (setq display-line-numbers 'relative)

#+end_src

Some utility functions used later on in other functions

#+begin_src emacs-lisp
  (defun insert-line-below ()
    "Insert an empty line below the current line."
    (interactive)
    (save-excursion
      (end-of-line)
      (open-line 1)))

  (defun insert-line-above ()
    "Insert an empty line above the current line."
    (interactive)
    (save-excursion
      (end-of-line 0)
      (open-line 1)))
#+end_src
** Managing whitespace

#+begin_src emacs-lisp

  (whitespace-mode)
  (setq whitespace-style '(face trailing))

#+end_src

** Buffer management
#+begin_src emacs-lisp

  (global-set-key (kbd "C-;") 'ibuffer)

#+end_src

#+end_src

** Helpful stuff
#+begin_src emacs-lisp

  (use-package helpful
    :defer 1
    :commands (helpful-callable helpful-variable helpful-command helpful-key))

  ;; Note that the built-in `describe-function' includes both functions
  ;; and macros. `helpful-function' is functions only, so we provide
  ;; `helpful-callable' as a drop-in replacement.
  (global-set-key (kbd "C-h f") #'helpful-callable)

  (global-set-key (kbd "C-h v") #'helpful-variable)
  (global-set-key (kbd "C-h k") #'helpful-key)

#+end_src

** Garbage collection + startup time report
#+begin_src emacs-lisp

  ;; Make startup faster by reducing the frequency of garbage
  ;; collection.  The default is 800 kilobytes.  Measured in bytes.
  (setq gc-cons-threshold (* 50 1000 1000))

  ;; The rest of the init file.

  ;; Make gc pauses faster by decreasing the threshold.
  ;; (setq gc-cons-threshold (* 2 1000 1000))

  ;; The default is 800 kilobytes.  Measured in bytes.
  ;; (setq gc-cons-percentage 0.6)
  ;; (setq gc-cons-threshold most-positive-fixnum)

  (defun display-startup-time ()
      "Display startup time."
      (message "Emacs loaded in %s with %d garbage collections."
              (format "%.2f seconds"
                      (float-time
                      (time-subtract after-init-time before-init-time)))
              gcs-done))

  (add-hook 'emacs-startup-hook #'display-startup-time)

#+end_src

** Whichkey for showing keybindings

#+begin_src emacs-lisp

  (use-package which-key
    :defer 1
    :config (which-key-mode))

#+end_src
** Org mode setup

#+begin_src emacs-lisp

  (defun efs/org-font-setup ()
    ;; Set faces for heading levels
    (dolist (face '((org-level-1 . 1.5)
                    (org-level-2 . 1.4)
                    (org-level-3 . 1.35)
                    (org-level-4 . 1.3)
                    (org-level-5 . 1.4)
                    (org-level-6 . 1.4)
                    (org-level-7 . 1.4)
                    (org-level-8 . 1.4)))
      (set-face-attribute (car face) nil :font "Source Code Pro" :weight 'regular :height (cdr face)))

    ;; Ensure that anything that should be fixed-pitch in Org files appears that way
    (set-face-attribute 'org-block nil    :family "Source Code Pro" :foreground nil :inherit 'fixed-pitch)
    (set-face-attribute 'org-table nil    :family "Source Code Pro" :inherit 'fixed-pitch)
    (set-face-attribute 'org-formula nil  :family "Source Code Pro" :inherit 'fixed-pitch)
    (set-face-attribute 'org-code nil     :family "Source Code Pro" :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-table nil    :family "Source Code Pro" :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-verbatim nil :family "Source Code Pro" :inherit '(shadow fixed-pitch))
    (set-face-attribute 'org-special-keyword nil :family "Source Code Pro" :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-meta-line nil :family "Source Code Pro" :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-checkbox nil :family "Source Code Pro" :inherit 'fixed-pitch)
    (set-face-attribute 'line-number nil :family "Source Code Pro" :inherit 'fixed-pitch)
    (set-face-attribute 'line-number-current-line nil :family "Source Code Pro" :inherit 'fixed-pitch))

  (defun sal/org-mode-setup ()
    "Org mode setup."
    (org-indent-mode)
    (auto-fill-mode)
    (global-linum-mode 0)
    (visual-line-mode 1))

  (use-package org
    :defer 1
    :hook (
           (org-mode . efs/org-font-setup)
           (org-mode . sal/org-mode-setup))
    :config
    (setq org-ellipsis " ▾"))

#+end_src
** Terminal buffer goodness

Sync up the path used with what's from my default shell .. I think

#+begin_src emacs-lisp

  (use-package exec-path-from-shell)
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize))

#+end_src
** Flycheck syntax checker tool & Flymake too

#+begin_src emacs-lisp

  (use-package flycheck
    :init
    (setq flycheck-check-syntax-automatically '(save mode-enabled))
    :config
    (add-hook 'after-init-hook #'global-flycheck-mode))

  (setq flycheck-javascript-eslint-executable "eslint_d")

  (use-package flycheck-posframe
    :after flycheck
    :config (add-hook 'flycheck-mode-hook #'flycheck-posframe-mode))

  ;; Disable jshint in favour of eslint
  (setq-default flycheck-disabled-checkers
                (append flycheck-disabled-checkers
                        '(javascript-jshint)))

  ;; use eslint with rjsx-mode for (j|t)sx? files
  ;; (flycheck-add-mode 'javascript-eslint 'rjsx-mode)
  (flycheck-add-mode 'javascript-eslint 'js2-mode)
  (flycheck-add-mode 'javascript-eslint 'typescript-mode)
  (flycheck-add-mode 'javascript-eslint 'rjsx-mode)

  ;; customize flycheck temp file prefix
  (setq-default flycheck-temp-prefix ".flycheck")

  ;; disable json-jsonlist checking for json files
  (setq-default flycheck-disabled-checkers
                (append flycheck-disabled-checkers
                        '(json-jsonlist)))

#+end_src

** Web mode

For files with HTML

#+begin_src emacs-lisp

  (use-package web-mode
    :defer 2)

  (use-package emmet-mode
    :defer 2
    :hook ((css-mode . emmet-mode)
           (scss-mode . emmet-mode)
           (web-mode . emmet-mode)
           (rjsx-mode . (lambda ()
                          (emmet-mode)
                          (setq-local emmet-expand-jsx-className? t) ;; default nil
                          ))))

  (use-package rjsx-mode
    :mode (
           ("\\.js\\'" . rjsx-mode)
           ("\\.jsx\\'" .  rjsx-mode)
           ))

#+end_src

** Interactive interface for completion

#+begin_src emacs-lisp

  ;; (load-file "~/dotfiles/emacs/conf-ivy.el")
  (load-file "~/dotfiles/emacs/conf-selectrum.el")

#+end_src

** Projectile: File finder

#+begin_src emacs-lisp
  (use-package projectile
    :diminish projectile-mode
    :config
    (define-key projectile-mode-map (kbd "C-x p") 'projectile-command-map)
    (projectile-mode))

  (use-package ibuffer-projectile)
  (add-hook 'ibuffer-hook
      (lambda ()
        (ibuffer-projectile-set-filter-groups)))

  (defun ibuffer-jump-to-last-buffer ()
    (ibuffer-jump-to-buffer (buffer-name (cadr (buffer-list)))))

  (add-hook 'ibuffer-hook #'ibuffer-jump-to-last-buffer)
#+end_src

** Sidebar project explorer

#+begin_src emacs-lisp
  (use-package neotree
    :defer 3
    :config
    (setq neo-theme (if (display-graphic-p) 'icons 'arrow)
          neo-hide-cursor t
          neo-window-width 30
          projectile-switch-project-action 'neotree-projectile-action)
    :general
    (:states 'normal
             :keymaps 'neotree-mode-map
             "md" 'neotree-delete-node
             "ma" 'neotree-create-node
             "mm" 'neotree-rename-node
             "R" 'neotree-refresh
             "RET" 'neotree-enter
             "?" 'describe-mode
             "H" 'neotree-hidden-file-toggle
             "q" 'neotree-hide
             "u" 'neotree-select-up-node))
#+end_src

** Visuals
*** Line numbers + highlight current line
#+begin_src emacs-lisp

  (defun sal-enable-linum ()
    (interactive)
    (if (eq nil display-line-numbers)
        (setq display-line-numbers 'relative)
      (message "Linum mode set")))
  (add-hook 'prog-mode-hook 'sal-enable-linum)

  (global-hl-line-mode 1) ;; Highlight the current line

#+end_src
*** Theme: DOOM
The doom themes are pretty cool

#+begin_src emacs-lisp

  (use-package all-the-icons)

  (use-package doom-themes
    :init
    (setq doom-themes-treemacs-theme "doom-colors")
    :config
    (load-theme 'doom-gruvbox t)
    (doom-themes-visual-bell-config))

  ;; (use-package doom-modeline
  ;;   :init
  ;;   (doom-modeline-mode 1))

#+end_src

*** Show open buffers as tabs!

#+begin_src emacs-lisp

  (use-package centaur-tabs
    :ensure nil
    :config
    (setq centaur-tabs-set-bar 'under
          x-underline-at-descent-line t
          centaur-tabs-set-icons t
          centaur-tabs-gray-out-icons 'buffer
          centaur-tabs-set-modified-marker t
          centaur-tabs-modified-marker "•")
    (centaur-tabs-headline-match)
    (centaur-tabs-group-by-projectile-project))

#+end_src
** Dashboard for opening projects / bookmarks / MRU

#+begin_src emacs-lisp

  (use-package dashboard
    :config
    (setq dashboard-set-heading-icons t
          dashboard-startup-banner 'logo
          dashboard-center-content nil
          dashboard-set-navigator t
          dashboard-set-file-icons t)
    (setq dashboard-items '((recents  . 10)
                            (bookmarks . 5)
                            (projects . 5)))
    (dashboard-setup-startup-hook))

#+end_src

** Preparation for evil mode

[[https://github.com/apchamberlain/undo-tree.el][Undo tree]] is for evil mode's `U` and `C-r` history

[[https://github.com/gregsexton/origami.el][Origami]] is for evil mode's folding capabilities

#+begin_src emacs-lisp
  (use-package undo-fu
    :config
    (global-undo-tree-mode -1))

  (use-package origami
    :config (global-origami-mode))

  (use-package drag-stuff
    :config
    (drag-stuff-mode t))
#+end_src

** EVIL mode ! >:)

#+begin_src emacs-lisp

  (use-package evil
    :init
    (setq evil-want-keybinding nil)
    (add-hook 'evil-local-mode-hook 'turn-on-undo-tree-mode)
    :custom
    (evil-want-C-u-scroll t)
    (evil-want-Y-yank-to-eol t)
    (evil-undo-system 'undo-fu)
    :config
    (evil-set-initial-state 'Custom-mode 'normal)
    (evil-set-initial-state 'dashboard-mode 'normal)
    (evil-mode 1))

  ;; Make sure evil bindings work in all emacs windows
  (setq evil-want-keybinding nil) ;; Evil collection requirement
  (use-package evil-collection
    :after evil
    :custom
    (evil-collection-want-unimpaired-p nil))
  (when (require 'evil-collection nil t)
    (evil-collection-init))

  (define-key evil-normal-state-map (kbd "u") 'undo-fu-only-undo)
  (define-key evil-normal-state-map (kbd "\C-r") 'undo-fu-only-redo)

  ;; mappings
  (define-key evil-normal-state-map (kbd "U") 'evil-redo)

  (define-key evil-normal-state-map (kbd "C-k") 'centaur-tabs-backward)
  (define-key evil-normal-state-map (kbd "C-j") 'centaur-tabs-forward)

  (define-key evil-normal-state-map (kbd "gm") 'evil-search-word-forward)

  (define-key evil-visual-state-map (kbd "J") 'drag-stuff-down)
  (define-key evil-visual-state-map (kbd "K") 'drag-stuff-up)

  (define-key evil-normal-state-map (kbd "gl") 'evil-end-of-line)
  (define-key evil-normal-state-map (kbd "gh") 'evil-beginning-of-line)

  (define-key evil-normal-state-map (kbd "[ SPC") 'insert-line-above)
  (define-key evil-normal-state-map (kbd "] SPC") 'insert-line-below)

  (define-key evil-normal-state-map (kbd "[ e") 'flymake-goto-prev-error)
  (define-key evil-normal-state-map (kbd "] e") 'flymake-goto-next-error)
  (evil-define-key 'normal 'global (kbd "C-p") 'flycheck-previous-error)
  (evil-define-key 'normal 'global (kbd "C-n") 'flycheck-next-error)

  (define-key key-translation-map (kbd "ESC") (kbd "C-g"))

  (use-package evil-leader
    :config (global-evil-leader-mode))

  ;; Leader key
  (evil-leader/set-leader "SPC")

  (leader-keys "qq" 'save-buffers-kill-terminal)

  (leader-keys
    "u" 'universal-argument)

  ;; Window
  (leader-keys
    "wq" 'delete-window
    "wo" 'other-window
    "wr" 'evil-window-rotate-upwards
    "w/" 'evil-window-vsplit
    "w-" 'evil-window-split
    "wh" 'evil-window-left
    "wj" 'evil-window-down
    "wk" 'evil-window-up
    "wl" 'evil-window-right
    ;; "wu" 'winner-undo
    ;; "wU" 'winner-redo
    )

  (evil-define-key 'normal 'org-mode-map (kbd "\\ e") 'org-edit-special)
  (evil-define-key 'normal 'org-mode-map (kbd "\\ q") 'org-edit-src-exit)

  ;; Comments
  (leader-keys
    "cc" 'comment-line)
  (evil-leader/set-key-for-mode
    'evil-visual-state "cc" 'evilnc-comment-or-uncomment-lines)

  ;; Project
  (leader-keys
    "ps" 'centaur-tabs-switch-group
    "po" 'projectile-switch-project)

  (use-package consult
    :config
    (setq consult-preview-key (kbd "C-\\")))

  ;; Search
  (leader-keys
    "sf" 'consult-line)

  (defun show-file-name ()
    "Show the full path file name in the minibuffer."
    (interactive)
    (message (buffer-file-name))
    (kill-new (file-truename buffer-file-name)))

  ;; File
  (leader-keys
    "fe" 'neotree
    "fj" 'dired-jump
    "fr" 'rename-file
    "f5" 'load-file
    "fs" 'evil-write-all
    "fy" 'show-file-name
    "f.s" 'save-buffer)

  (use-package dired
    :ensure nil
    :commands (dired dired-jump)
    :bind (("C-x C-j" . dired-jump))
    :config
    (evil-collection-define-key 'normal 'dired-mode-map
      (kbd "RET" ) 'dired-single-buffer
      "h" 'dired-single-up-directory
      "l" 'dired-single-buffer
      "c" 'find-file
      ))

  (use-package dired-single
    :commands (dired dired-jump))

  (use-package all-the-icons-dired
    :hook (dired-mode . all-the-icons-dired-mode))

  (use-package dired-open
    :commands
    (dired dired-jump)
    :config
    (setq dired-open-extensions '(("png" . "feh")
                                  ("mkv" . "mpv"))))

  ;; Buffer
  (leader-keys
    "h" 'help-command
    "bd" 'kill-this-buffer
    "TAB" 'evil-switch-to-windows-last-buffer)

  (use-package evil-nerd-commenter)

  (use-package evil-surround :config (global-evil-surround-mode 1))

  (use-package evil-goggles
    :config
    (evil-goggles-mode)
    (setq evil-goggles-duration 0.500
          evil-goggles-blocking-duration 0.001
          evil-goggles-async-duration 0.900
          evil-goggles-enable-paste nil
          evil-goggles-enable-delete nil
          evil-goggles-enable-change nil
          evil-goggles-enable-indent nil
          evil-goggles-enable-join nil
          evil-goggles-enable-fill-and-move nil
          evil-goggles-enable-paste nil
          evil-goggles-enable-shift nil
          evil-goggles-enable-surround nil
          evil-goggles-enable-commentary nil
          evil-goggles-enable-nerd-commenter nil
          evil-goggles-enable-replace-with-register nil
          evil-goggles-enable-set-marker nil
          evil-goggles-enable-undo nil
          evil-goggles-enable-redo nil
          evil-goggles-enable-record-macro nil))

#+end_src

** Helpful post-evil stuff
   #+begin_src emacs-lisp

     (use-package hydra
       :defer 1)

     (defhydra hydra-text-scale (:timeout 4)
       "scale text"
       ("j" text-scale-increase "in")
       ("k" text-scale-decrease "out")
       ("f" nil "finished" :exit t))

     (leader-keys
       "tf" '(hydra-text-scale/body :which-key "scale text"))

     (defhydra hydra-scroll-page (:timeout 4)
       "scroll the page"
       ("k" evil-scroll-up "up")
       ("j" evil-scroll-down "down")
       ("f" nil "finished" :exit t))

     (leader-keys
       "ts" '(hydra-scroll-page/body :which-key "scroll page"))

     (defhydra hydra-emmet (:timeout 4)
       "interact with emmet"
       ("," emmet-expand-line "expand line")
       ("f" nil "finished" :exit t))

     ;; (evil-define-key 'insert 'evil-insert-state-map (kbd "C-y") (hydra-emmet/body :which-key "emmet"))

   #+end_src

** Avy: vim-sneak equivalent

Quickly navigate anywhere in the visible file with 2 character
filtering followed by RET to go there

#+begin_src emacs-lisp
  (use-package avy
      :custom
      (avy-all-windows nil))

  (evil-define-key 'normal 'global (kbd "s") 'avy-goto-char-2-below)
  (evil-define-key 'normal 'global (kbd "S") 'avy-goto-char-2-above)
  (evil-define-key 'visual 'global (kbd "s") 'avy-goto-char-2)

  (leader-keys
    "sw" 'avy-goto-word-0-below
    "Sw" 'avy-goto-word-0-above)
#+end_src

** Company: Auto-complete goodness

[[https://company-mode.github.io/][Company]] is a text completion framework for Emacs. The name stands for "complete anything". It uses pluggable back-ends and front-ends to retrieve and display completion candidates.

[[https://github.com/sebastiencs/company-box][Company box]] adds some cool icons

[[https://github.com/company-mode/company-quickhelp][Company quickhelp]] adds overlay documentation for the options company provides

#+begin_src emacs-lisp
  (use-package company
    :init
    (add-hook 'after-init-hook 'global-company-mode)
    :config
    (company-tng-mode)
    (setq company-idle-delay 0
          company-minimum-prefix-length 1
          company-selection-wrap-around t))

    (use-package company-box :hook (company-mode . company-box-mode))

    (use-package pos-tip)
    (use-package company-quickhelp :config (company-quickhelp-mode))

    (eval-after-load 'company
      '(define-key company-active-map (kbd "C-c h") #'company-quickhelp-manual-begin))

    ;; aligns annotation to the right hand side
    (setq company-tooltip-align-annotations t)
#+end_src

** Eglot/LSP for IDE LSP experience
#+begin_src emacs-lisp

  (use-package eglot)

  ;; lsp-mode
  (setq lsp-log-io nil) ;; Don't log everything = speed
  (setq lsp-keymap-prefix "C-c l")
  (setq lsp-restart 'auto-restart)
  (setq lsp-ui-sideline-enable nil)
  (setq lsp-ui-doc-enable t)
  (setq lsp-ui-doc-position 'top)
  (setq lsp-headerline-breadcrumb-enable nil)

  (evil-define-key 'normal 'lsp-ui-doc-frame-mode
    [?q] #'lsp-ui-doc-unfocus-frame)
  (evil-normalize-keymaps)

  (evil-define-key 'normal 'lsp-ui-doc-mode
    [?K] #'lsp-ui-doc-focus-frame)

  (use-package lsp-mode
    :config
    (evil-leader/set-key-for-mode 'lsp-mode "gd" 'lsp-find-definition)
    (lsp-enable-which-key-integration t)
    :hook (
           (typescript-mode . lsp-deferred)
           (rjsx-mode . lsp-deferred)
           (web-mode . lsp-deferred)
           (python-mode . lsp-deferred)
           (lsp-mode . lsp-enable-which-key-integration)
           )
    :commands lsp-deferred)

  (use-package lsp-ui
    :ensure t
    :commands lsp-ui-mode)

#+end_src
** Javascript/Typescript setup

#+begin_src emacs-lisp

  (setq js2-mode-show-parse-errors nil)
  (setq js2-mode-show-strict-warnings nil)

  (use-package typescript-mode
    :mode (
         ("\\.ts\\'" . typescript-mode)
           ))

  (use-package prettier-js
    :hook
    ((typescript-mode rjsx-mode web-mode scss-mode css-mode) . prettier-js-mode))

  (use-package eslintd-fix
    :hook
    ((typescript-mode rjsx-mode web-mode) . eslintd-fix-mode))

#+end_src

*** Support for .jsx?/.tsx? files

#+begin_src emacs-lisp

  (use-package web-mode
    :mode (
       ("\\.tsx\\'" . web-mode)
       ("\\.html\\'" . web-mode))
    :commands web-mode)

  (defun enable-minor-mode (my-pair)
    "Enable minor mode if filename match the regexp.  MY-PAIR is a cons cell (regexp . minor-mode)."
    (if (buffer-file-name)
        (if (string-match (car my-pair) buffer-file-name)
        (funcall (cdr my-pair)))))

  (use-package prettier-js
    :ensure t)
  (add-hook 'web-mode-hook #'(lambda ()
                               (enable-minor-mode
                                '("\\.jsx?\\'" . prettier-js-mode))
                   (enable-minor-mode
                                '("\\.tsx?\\'" . prettier-js-mode))))

#+end_src

** Python setup

If you open a file in a project that has a python virtual environment
made available to you, make use of it!

#+begin_src emacs-lisp

  (use-package python
    :delight "π "
    :bind (("M-[" . python-nav-backward-block)
           ("M-]" . python-nav-forward-block))
    :preface
    (defun python-remove-unused-imports()
      "Removes unused imports and unused variables with autoflake."
      (interactive)
      (if (executable-find "autoflake")
          (progn
            (shell-command (format "autoflake --remove-all-unused-imports -i %s"
                                   (shell-quote-argument (buffer-file-name))))
            (revert-buffer t t t))
        (warn "python-mode: Cannot find autoflake executable."))))

  (use-package pyvenv
    :after python)

  (use-package pipenv
    :hook (python-mode . pipenv-mode)
    :init
    (setq pipenv-projectile-after-switch-function #'pipenv-projectile-after-switch-extended))

  (use-package lsp-python-ms
    :ensure t
    :init (setq lsp-python-ms-auto-install-server t)
    :hook (python-mode . (lambda ()
                            (require 'lsp-python-ms)
                            (lsp-deferred))))  ; or lsp-deferred

#+end_src

** Magit - GIT

#+begin_src emacs-lisp

  (use-package magit
    :commands magit-status
    :custom
    (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))

  (leader-keys
    "gs" 'magit-status)

  (defun kill-magit-diff-buffer-in-current-repo (&rest _)
    "Delete the magit-diff buffer related to the current repo"
    (let ((magit-diff-buffer-in-current-repo
           (magit-mode-get-buffer 'magit-diff-mode)))
      (kill-buffer magit-diff-buffer-in-current-repo)))
  ;;
  ;; When 'C-c C-c' is pressed in the magit commit message buffer,
  ;; delete the magit-diff buffer related to the current repo.
  ;;
  (add-hook 'git-commit-setup-hook
            (lambda ()
              (add-hook 'with-editor-post-finish-hook
                        #'kill-magit-diff-buffer-in-current-repo
                        nil t))) ; the t is important

#+end_src

** Terminal mode
#+begin_src emacs-lisp
  (use-package vterm
    :commands vterm
    :config
    (setq vterm-max-scrollback 10000)
    :hook
    (vterm-mode . (lambda ()
                    (setq-local global-hl-line-mode nil))))

  (use-package multi-vterm
      :config
      (define-key vterm-mode-map [return]                      #'vterm-send-return)

      (setq vterm-keymap-exceptions nil)
      (evil-define-key 'insert vterm-mode-map (kbd "C-e")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-f")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-a")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-v")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-b")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-w")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-u")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-n")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-m")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-p")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-j")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-k")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-r")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-t")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-g")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-c")      #'vterm--self-insert)
      (evil-define-key 'insert vterm-mode-map (kbd "C-SPC")    #'vterm--self-insert)
      (evil-define-key 'normal vterm-mode-map (kbd "C-d")      #'vterm--self-insert)
      (evil-define-key 'normal vterm-mode-map (kbd ",c")       #'multi-vterm)
      (evil-define-key 'normal vterm-mode-map (kbd ",n")       #'multi-vterm-next)
      (evil-define-key 'normal vterm-mode-map (kbd ",p")       #'multi-vterm-prev)
      (evil-define-key 'normal vterm-mode-map (kbd "i")        #'evil-insert-resume)
      (evil-define-key 'normal vterm-mode-map (kbd "o")        #'evil-insert-resume)
      (evil-define-key 'normal vterm-mode-map (kbd "<return>") #'evil-insert-resume))

  (use-package eterm-256color
    :hook (vterm-mode . eterm-256color-mode))

  (use-package ivy)

  (use-package theme-looper)

  (defun sal-cd-project-root ()
    (cd (projectile-project-root)))

  ;; Terminal
  (leader-keys
    "t" '(:ignore t :which-key "terminal")
    "tt" (lambda ()
           (interactive)
           (sal-cd-project-root)
           (multi-vterm))
    "t/" (lambda ()
           (interactive)
           (split-window-right)
           (other-window 1)
           (sal-cd-project-root)
           (multi-vterm))
    "t-" (lambda ()
           (interactive)
           (split-window-below)
           (other-window 1)
           (sal-cd-project-root)
           (multi-vterm)))
#+end_src
** Clipboard management
#+begin_src emacs-lisp
  (defun isolate-kill-ring()
    "Isolate Emacs kill ring from OS X system pasteboard.
     This function is only necessary in window system."
    (interactive)
    (setq interprogram-cut-function nil)
    (setq interprogram-paste-function nil))

  (defun pasteboard-copy()
    "Copy region to OS X system pasteboard."
    (interactive)
    (shell-command-on-region
     (region-beginning) (region-end) "pbcopy"))

  (defun pasteboard-paste()
    "Paste from OS X system pasteboard via `pbpaste' to point."
    (interactive)
    (shell-command-on-region
     (point) (if mark-active (mark) (point)) "pbpaste" nil t))

  (defun pasteboard-cut()
    "Cut region and put on OS X system pasteboard."
    (interactive)
    (pasteboard-copy)
    (delete-region (region-beginning) (region-end)))

  (if window-system
      (progn
        (isolate-kill-ring)
        ;; bind CMD+C to pasteboard-copy
        (leader-keys
          "/c" 'pasteboard-copy
          "/v" 'pasteboard-paste
          "/x" 'pasteboard-cut))

    ;; you might also want to assign some keybindings for non-window
    ;; system usage (i.e., in your text terminal, where the
    ;; command->super does not work)
    )
